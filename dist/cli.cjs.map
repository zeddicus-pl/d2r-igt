{"mappings":";;;;;;;;;;ACAA;;;;;;IAOO,yCAKN;UALW,SAAQ;IAAR,SAAQ,CAAR,SAAQ,CAClB,SAAO,IAAP,CAAO,IAAP,SAAO;IADG,SAAQ,CAAR,SAAQ,CAElB,SAAO,IAAP,CAAO,IAAP,SAAO;IAFG,SAAQ,CAAR,SAAQ,CAGlB,SAAO,IAAP,CAAO,IAAP,SAAO;IAHG,SAAQ,CAAR,SAAQ,CAIlB,SAAO,IAAP,CAAO,IAAP,SAAO;GAJG,yCAAQ,KAAR,yCAAQ;AAOpB,CAAA,GAAA,qBAAC,CAAA,CAAC,MAAM,CAAC,oBAAoB,CAAC,GAAG;IAAC,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI;IAAE,EAAE;CAAC,CAAC;AAC9C,CAAA,GAAA,qBAAC,CAAA,CAAC,MAAM,CAAC,eAAe,CAAC,GAAG;IAAC,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI;IAAE;QAAC,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI;QAAE,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI;KAAC;CAAC,CAAC;AACvD,CAAA,GAAA,qBAAC,CAAA,CAAC,MAAM,CAAC,gBAAgB,CAAC,GAAG;IAAC,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI;IAAE;QAAC,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI;QAAE,CAAA,GAAA,sBAAC,CAAA,CAAC,OAAO;KAAC;CAAC,CAAC;AAC3D,MAAM,4BAAM,GAAG,CAAA,GAAA,qBAAC,CAAA,CAAC,IAAI,EAAE,AAAC;AACxB,MAAM,4BAAM,GAAG,CAAA,GAAA,4CAAQ,CAAA,CAAC,cAAG,CAAC,AAAC;AAE7B,IAAI,8BAAQ,GAAG,yCAAQ,CAAC,OAAO,AAAC;AAChC,IAAI,0BAAI,GAAW,CAAC,AAAC;AACrB,IAAI,8BAAQ,GAAG,GAAG,AAAC;AACnB,IAAI,2BAAK,AAAc,AAAC;AAGxB,IAAI,8BAAQ,GAAgB,CAAC,KAAK,GAAK,EAAE,AAAC;AAE1C,4BAAM,CAAC,kBAAkB,EAAE,CAAC;AAErB,MAAM,yCAAc,GAAG,CAAC,WAAwB,GAAK;IAC1D,8BAAQ,GAAG,WAAW,CAAC;CACxB;AAEM,MAAM,yCAAQ,GAAG,IAAM;IAC5B,8BAAQ,GAAG,yCAAQ,CAAC,OAAO,CAAC;IAC5B,0BAAI,GAAG,CAAC,CAAC;IACT,2BAAK,GAAG,UAAU,CAAC,oCAAc,EAAE,8BAAQ,CAAC;CAC7C;AAEM,MAAM,yCAAO,GAAG,IAAM;IAC3B,aAAa,CAAC,2BAAK,CAAC,CAAC;CACtB;AAED,MAAM,0CAAoB,GAAG,CAAC,KAAe,GAAK;IAChD,IAAI,KAAK,IAAI,8BAAQ,EAAE;QACrB,8BAAQ,GAAG,KAAK,CAAC;QACjB,8BAAQ,CAAC,8BAAQ,CAAC,CAAC;KACpB;CACF;AAED,MAAM,oCAAc,GAAG,IAAM;IAC3B,2BAAK,GAAG,UAAU,CAAC,IAAM;QACvB,gCAAU,EAAE,CAAC;QACb,oCAAc,EAAE,CAAC;KAClB,EAAE,8BAAQ,CAAC,CAAC;CACd;AAED,MAAM,qCAAe,GAAG,uBAAY,CAClC,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI,EACN;IAAC,CAAA,GAAA,sBAAC,CAAA,CAAC,IAAI;IAAE,CAAA,GAAA,sBAAC,CAAA,CAAC,MAAM;CAAC,EAClB,CAAC,MAAc,EAAE,MAAgB,GAAgB;IAC/C,MAAM,GAAG,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC;IAC7B,4BAAM,CAAC,cAAc,CAAC,MAAM,EAAE,GAAG,EAAE,GAAG,CAAC,UAAU,CAAC,CAAC;IACnD,IAAI,GAAG,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,OAAO,SAAS,EAAE,CAAC,IAAI,wBAAwB,EAAE;QACxE,0BAAI,GAAG,MAAM,CAAC;QACd,OAAO,KAAK,CAAC;KACd;IACD,OAAO,IAAI,CAAC;CACb,CACF;AAED,MAAM,4BAAM,GAAG,IAAM;IACnB,0CAAoB,CAAC,yCAAQ,CAAC,OAAO,CAAC,CAAC;IACvC,0BAAI,GAAG,CAAC,CAAC;IACT,8BAAQ,GAAG,GAAG,CAAC;CAChB;AAED,MAAM,iCAAW,GAAG,IAAM;IACxB,0CAAoB,CAAC,yCAAQ,CAAC,OAAO,CAAC,CAAC;IACvC,8BAAQ,GAAG,EAAE,CAAC;CACf;AAED,MAAM,iCAAW,GAAG,IAAM;IACxB,0CAAoB,CAAC,yCAAQ,CAAC,OAAO,CAAC,CAAC;IACvC,8BAAQ,GAAG,EAAE,CAAC;CACf;AAED,MAAM,gCAAU,GAAG,IAAM;IACvB,IAAI,0BAAI,KAAK,CAAC,EAAE;QACd,4BAAM,CAAC,WAAW,CAAC,qCAAe,EAAE,CAAC,CAAC,CAAC;QACvC,IAAI,0BAAI,KAAK,CAAC,EAAE;YACd,4BAAM,EAAE,CAAC;YACT,OAAO;SACR;KACF;IAED,iBAAiB,CACjB,MAAM,MAAM,GAAmB,IAAI,4BAAM,CAAC,CAAA,GAAA,uBAAE,CAAA,CAAC,KAAK,CAAC,EAAE,AAAC;IACtD,MAAM,IAAI,GAAG,4BAAM,CAAC,cAAc,CAAC,0BAAI,EAAE,MAAM,CAAC,GAAG,EAAE,CAAC;IACtD,IAAI,IAAI,IAAI,CAAC,EAAE;QACb,4BAAM,EAAE,CAAC;QACT,OAAO;KACR;IAED,iBAAiB,CACjB,MAAM,UAAU,GAAkB,IAAI,4BAAM,CAAC,CAAA,GAAA,uBAAE,CAAA,CAAC,IAAI,CAAC,EAAE,AAAC;IACxD,MAAM,GAAG,GAAG,4BAAM,CAAC,aAAa,CAAC,0BAAI,EAAE,UAAU,CAAC,GAAG,EAAE,CAAC;IACxD,IAAI,GAAG,IAAI,CAAC,EAAE;QACZ,4BAAM,EAAE,CAAC;QACT,OAAO;KACR;IAED,MAAM,CAAC,GAAG,UAAU,CAAC,KAAK,AAAC;IAC3B,MAAM,CAAC,GAAG,UAAU,CAAC,MAAM,AAAC;IAC5B,MAAM,CAAC,GAAG,MAAM,CAAC,CAAC,AAAC;IACnB,MAAM,CAAC,GAAG,MAAM,CAAC,CAAC,AAAC;IAEnB,MAAM,UAAU,GAAG,CAAA,GAAA,mCAAiB,CAAA,CAAC;QACnC,aAAa,EAAE,IAAI,CAAA,GAAA,uBAAK,CAAA,CAAC,CAAC,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,CAAC,GAAG,GAAG,EAAE,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,GAAG,EAAE,CAAC,CAAC;KACzE,CAAC,AAAC;IAEH,MAAM,SAAS,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,SAAS,EAAE,IAAI,QAAQ,IACjE,UAAU,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,SAAS,EAAE,IAAI,QAAQ,IACnD,UAAU,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC,SAAS,EAAE,IAAI,QAAQ,AAAC;IAEtD,IAAI,SAAS,EACX,iCAAW,EAAE,CAAC;SAEd,iCAAW,EAAE,CAAC;CAEjB,AAAC;;ADnIF;AAEA,CAAA,GAAA,yCAAc,CAAA,CAAC,CAAC,KAAK,GAAK;IACtB,IAAI,QAAQ,GAAG,EAAE,AAAC;IAClB,OAAQ,KAAK;QACT,KAAK,CAAA,GAAA,yCAAQ,CAAA,CAAC,OAAO;YACjB,QAAQ,GAAG,SAAS,CAAC;YACrB,MAAM;QACV,KAAK,CAAA,GAAA,yCAAQ,CAAA,CAAC,OAAO;YACjB,QAAQ,GAAG,SAAS,CAAC;YACrB,MAAM;QACV,KAAK,CAAA,GAAA,yCAAQ,CAAA,CAAC,OAAO;YACjB,QAAQ,GAAG,SAAS,CAAC;YACrB,MAAM;QACV;YACI,QAAQ,GAAG,SAAS,CAAC;KAC5B;IACD,OAAO,CAAC,GAAG,CAAC,oBAAoB,GAAG,QAAQ,CAAC,CAAC;CAChD,CAAC,CAAC;AAEH,CAAA,GAAA,yCAAQ,CAAA,EAAE,CAAC;AAEX,OAAO,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;AACpB,WAAW,CAAC,IAAM,EAAE,EAAE,IAAI,CAAC,CAAC","sources":["cli.ts","igt.ts"],"sourcesContent":["import { setIgtCallback, startIgt, IgtState } from './igt';\n\nsetIgtCallback((state) => {\n    let stateStr = '';\n    switch (state) {\n        case IgtState.LOADING:\n            stateStr = 'Loading';\n            break;\n        case IgtState.PLAYING:\n            stateStr = 'Playing';\n            break;\n        case IgtState.NO_GAME:\n            stateStr = 'No game';\n            break;\n        default:\n            stateStr = 'Unknown';\n    }\n    console.log('State changed to: ' + stateStr);\n});\n\nstartIgt();\n\nconsole.log('test');\nsetInterval(() => {}, 1000);","import { U } from 'zedd-win32-api';\nimport StructDi from 'ref-struct-di';\nimport * as ffi from 'ffi-napi';\nimport * as ref from 'ref-napi';\nimport { DModel as M, DStruct as DS, DTypes as W } from 'win32-def';\nimport { VRect, CaptureScreenshot } from \"windows-ffi\";\n\nexport enum IgtState {\n  UNKNOWN,\n  NO_GAME,\n  PLAYING,\n  LOADING\n}\n\nU.apiDef['SetProcessDPIAware'] = [W.BOOL, []];\nU.apiDef['GetClientRect'] = [W.BOOL, [W.HWND, W.RECT]];\nU.apiDef['ClientToScreen'] = [W.BOOL, [W.HWND, W.LPPOINT]];\nconst user32 = U.load();\nconst Struct = StructDi(ref);\n\nlet igtState = IgtState.UNKNOWN;\nlet hwnd: M.HWND = 0;\nlet tickTime = 500;\nlet timer: NodeJS.Timer;\n\ntype IgtCallback = (state: IgtState) => void;\nlet callback: IgtCallback = (state) => {};\n\nuser32.SetProcessDPIAware();\n\nexport const setIgtCallback = (igtCallback: IgtCallback) => {\n  callback = igtCallback;\n}\n\nexport const startIgt = () => {\n  igtState = IgtState.UNKNOWN;\n  hwnd = 0;\n  timer = setTimeout(tickProcessIgt, tickTime)\n}\n\nexport const stopIgt = () => {\n  clearInterval(timer);\n}\n\nconst runCallbackIfChanged = (state: IgtState) => {\n  if (state != igtState) {\n    igtState = state;\n    callback(igtState);\n  }\n}\n\nconst tickProcessIgt = () => {\n  timer = setTimeout(() => {\n    processIgt();\n    tickProcessIgt();\n  }, tickTime);\n}\n\nconst enumWindowsProc = ffi.Callback(\n  W.BOOL,\n  [W.HWND, W.LPARAM],\n  (window: M.HWND, lParam: M.LPARAM): M.BOOLEAN => {\n    const buf = Buffer.alloc(254)\n    user32.GetWindowTextW(window, buf, buf.byteLength);\n    if (buf.toString('ucs2').replace(/\\0+$/, '') == \"Diablo II: Resurrected\") {\n      hwnd = window;\n      return false;\n    }\n    return true;\n  },\n)\n\nconst noGame = () => {\n  runCallbackIfChanged(IgtState.NO_GAME);\n  hwnd = 0;\n  tickTime = 500;\n}\n\nconst gameLoading = () => {\n  runCallbackIfChanged(IgtState.LOADING);\n  tickTime = 10;\n}\n\nconst gamePlaying = () => {\n  runCallbackIfChanged(IgtState.PLAYING);\n  tickTime = 10;\n}\n\nconst processIgt = () => {\n  if (hwnd === 0) {\n    user32.EnumWindows(enumWindowsProc, 0);\n    if (hwnd === 0) {\n      noGame();\n      return;\n    }\n  }\n\n  /** @ts-ignore */\n  const origin: M.POINT_Struct = new Struct(DS.POINT)();\n  const retw = user32.ClientToScreen(hwnd, origin.ref())\n  if (retw == 0) {\n    noGame();\n    return;\n  }\n  \n  /** @ts-ignore */\n  const rectClient: M.RECT_Struct = new Struct(DS.RECT)();\n  const ret = user32.GetClientRect(hwnd, rectClient.ref())\n  if (ret == 0) {\n    noGame();\n    return;\n  }\n\n  const w = rectClient.right;\n  const h = rectClient.bottom;\n  const x = origin.x;\n  const y = origin.y;\n\n  const screenshot = CaptureScreenshot({\n    rectToCapture: new VRect(x + Math.round(w / 2) - 100, y + h - 1, 200, 1),\n  });\n\n  const isLoading = screenshot.GetPixel(0, 0).ToHex_RGB() == '000000' &&\n    screenshot.GetPixel(100, 0).ToHex_RGB() == '000000' &&\n    screenshot.GetPixel(199, 0).ToHex_RGB() == '000000';\n\n  if (isLoading) {\n    gameLoading();\n  } else {\n    gamePlaying();\n  }\n};\n"],"names":[],"version":3,"file":"cli.cjs.map","sourceRoot":"../"}